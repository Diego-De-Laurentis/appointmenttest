<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confirm details</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="container">
    <h2>Confirm your appointment</h2>
    <p id="slot-info" class="muted"></p>

    <form id="details-form">
      <label>Full name<input name="name" required /></label>
      <label>Email<input name="email" type="email" required /></label>
      <label>Phone (optional)<input name="phone" /></label>

      <div class="terms">
        <h3>Terms</h3>
        <ul>
          <li>Arrive 5 minutes early.</li>
          <li>24-hour cancellation policy.</li>
          <li>We store your data only for booking and compliance.</li>
        </ul>
        <label class="checkbox">
          <input type="checkbox" name="termsAccepted" required /> I accept the terms.
        </label>
      </div>

      <input type="hidden" name="slotId" />
      <button class="btn" type="submit">Submit</button>
    </form>

    <p id="status" class="muted"></p>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const slotId = params.get('slot');
    const start = params.get('start');
    document.querySelector('input[name="slotId"]').value = slotId;
    document.getElementById('slot-info').textContent = start ? `Selected time: ${new Date(start).toLocaleString()}` : '';

    document.getElementById('details-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const payload = Object.fromEntries(fd.entries());
      payload.termsAccepted = !!payload.termsAccepted;
      const r = await fetch('/api/appointments', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      const out = document.getElementById('status');
      if (!r.ok) {
        const { error } = await r.json();
        out.textContent = error || 'Error';
        return;
      }
      out.textContent = 'Check your email to confirm. The provider will confirm too.';
    });
  </script>
</body>
</html>
